#+TITLE: Análise de Sentimento das Atas do Compom
#+AUTHOR: Gabriel Petrini
#+DATE: 2º Semestre de 2020
#+LANG: pt_Br
#+PROPERTY: header-args:R  :session *R* :results output replace :exports both :eval no-export :tangle no
* LaTeX headers                                         :noexport:ignore:

* HTML headers                                         :noexport:ignore:
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>

#+HTML_HEAD: <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
#+HTML_HEAD: <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>



* Introdução

Este arquivo faz uma análise de sentimento das Atas do Compom tal como em [[https://github.com/gabrielrega/sentimento][link]].

* Criando funções

#+begin_src R
pontuar_html <- function(x) {
  
  z <- read_html(x) %>% 
    html_nodes("div.lista1") %>% 
    html_text() %>% 
    str_split("\r\r\n") %>% 
    unlist() %>% 
    as_tibble() %>% 
    unnest_tokens(term, value) %>% 
    inner_join(oplexicon_v3.0) %>% 
    .$polarity %>% 
    sum()
  
  return(z)
}

pontuar_pdf <- function(x) {
  x <- pdf_text(x)
  baz <- gsub("\n", "", x)
  baz <- gsub("\r", " ", baz)
  tex <- baz %>% 
    as_tibble() %>% 
    unnest_tokens(term, value) %>% 
    inner_join(oplexicon_v3.0) %>% 
    .$polarity %>% 
    sum()
  return(tex)
}

extrair_pdf <- function(x) {
  b <- pdf_text(x) %>% 
    str_split("\r\n") %>% 
    unlist() %>% 
    paste(collapse = " ") %>% 
    str_squish()
  return(b)
}

extrair_html <- function(x) {
  
  t <- read_html(x) %>% 
    html_nodes("div.lista1") %>% 
    html_text() %>% 
    str_split("\r\r\n") %>% 
    unlist() %>% 
    paste(collapse = " ") %>% 
    str_squish()
  return(t)
  
}

extrair_html2 <- function(x) {
  
  t <- read_html(x) %>% 
    html_nodes("div.conteudo") %>% 
    html_text() %>% 
    str_split("\r\r\n") %>% 
    unlist() %>% 
    paste(collapse = " ") %>% 
    str_squish()
  return(t)
  
}

extrair_txt <- function(x) {
  y <- as.integer(str_sub(x, 14, -5))
    if (y < 97) {
    return(extrair_html2(x))
  } else {
    if (y < 200) {
      return(extrair_html(x))
    } else {
      return(extrair_pdf(x))
    }
  }
}

datar_html <- function(x) {
  z <- read_html(x) %>% 
    html_nodes("meta") %>% 
    html_attr("content") %>%
    .[5] %>% 
    dmy() %>% 
    as.character()
  
  return(z)
}

datar_pdf <- function(x) {
  z <- pdf_info(x) %>% 
    .$modified %>% 
    str_sub(1, 10) %>% 
    ymd() %>% 
    as.character()
  return(z)
}

extrair_data <- function(x) {
  y <- as.integer(str_sub(x, 14, -5))
  if (y < 200) {
      return(datar_html(x))
    } else {
      return(datar_pdf(x))
    }
}

pontuar_lista <- function(x) {
  p <- x %>%
    inner_join(oplexicon_v3.0) %>% 
    .$polarity %>% 
    sum()
  return(p)
}

pontuar_texto <- function(x) {
  p <- x %>%
    as_tibble() %>% 
    unnest_tokens(term, value) %>% 
    inner_join(oplexicon_v3.0) %>% 
    .$polarity %>% 
    sum()
  return(p)
}
#+end_src

#+RESULTS:

* Baixando atas

#+begin_src R
library(tidyverse)

download_ata <- function(n_ata = 200) {
  url = paste0("http://www.bcb.gov.br/?COPOM", n_ata)
  if (n_ata < 200) {
    destfile = paste0("./atas/copom_", n_ata, ".htm")
  } else {
    destfile = paste0("./atas/copom_", n_ata, ".pdf")
  }
  download.file(url = url,
                destfile = destfile,
                mode = "wb",
                extra = '-L')
}


seq(from = 21, to = 212) %>% map(download_ata)
#+end_src

#+RESULTS:
: Erro: package or namespace load failed for ‘tidyverse’ in dyn.load(file, DLLpath = DLLpath, ...):
:  impossível carregar objeto compartilhado '/home/gpetrini/R/x86_64-pc-linux-gnu-library/3.6/stringi/libs/stringi.so':
:   libicui18n.so.60: não é possível abrir arquivo compartilhado: Arquivo ou diretório não encontrado
: Error in seq(from = 21, to = 212) %>% map(download_ata) : 
:   não foi possível encontrar a função "%>%"

* Construindo tabelas 
