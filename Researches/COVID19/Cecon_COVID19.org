

#+TITLE: Impactos econômicos da COVID-19
#+AUTHOR: Pedro Paulo Zahluth Bastos, Luiz Celso Gomes Jr, Lorena Salces Dourado, Gabriel Petrini, Paulo Robilloti, Antonio Ibarra
#+DATE: September 2020
#+PROPERTY: header-args    :results output drawer :exports results :async t

* TODOs                                                            :noexport:

** Leading indicators

*** TODO [#A] CLI

*** TODO [#B] JPMorgan Index

*** TODO [#B] Sondagem FGV

*OBS:* Algumas células contém a palavra ~Prévia~ e foi removida para facilitar o código. Provavelmente não será necessário alterar quando os dados de agosto forem atualizados.

** Granular data

*** TODO [#A] Energy Consumption


** PNAD Covid

** GDP related

*** Credit Consumption

* Dados Granulares

** Energia

#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np
from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
from matplotlib.ticker import FuncFormatter

import seaborn as sns
import pandas_datareader.data as web
import requests
import json

import country_converter as coco
cc = coco.CountryConverter()

import matplotlib.image as image

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

infos = {
    'Country' : [],
    'Type': [],
    'Usage': [],
    'Source': [],
    'Units' : [],
    'Frequency' : [],
    'Link' : []
        }


def get_energy_links(start=1577833200000, end=1590443159999,  path='../data/'):
    countries = [
        "AT", # Austria
        'DE', # Germany
    ]
    for country in countries:
        url = f"https://www.smard.de/en/downloadcenter/download_market_data/5730#!?downloadAttributes=%7B%22selectedCategory%22:1,%22selectedSubCategory%22:1,%22selectedRegion%22:%22{country}%22,%22from%22:{start},%22to%22:{end},%22selectedFileType%22:%22CSV%22%7D"
        url = url.replace('%22', '"').replace('%7B', '{').replace('%7D', '}')
        print(url)

def ploter(df, country, days=365, units="MWh"):
    fig, ax = plt.subplots(1,2, figsize=(8,5), dpi=300)
    df.plot(ax=ax[0], 
             ls='-', 
             title= f"Energy consumption for {country}\nTotal {units}",
             color='darkred'
            )
    df.pct_change(days).dropna().plot(ax=ax[1], 
             ls='-', 
             title= f"Energy consumption for {country}",
             color='darkred',
             label="Year over Year Growth rate"
            )
    df.pct_change(days).rolling(7).mean().dropna().plot(ax=ax[1], 
             ls='--', 
             label="1 Week Moving average",
             color='black'
            )
    ax[1].legend(labels=("YoY Growth rate", "1 Week Moving average"))
    ax[1].axhline(y=0, ls='--', color='black')
    
    ax2 = plt.axes([0.08,0.12,0.2,0.2])
    ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
    ax2.axis('off')
    ax3 = plt.axes([0.58,0.12,0.2,0.2])
    ax3.imshow(logo, aspect='auto', zorder=0, alpha=.5)
    ax3.axis('off')
    sns.despine()
    plt.tight_layout()
    plt.show()
    fig.savefig(
        f"./figs/Energia/DailyEnergyConsumption_{country}_{units}.svg", 
        dpi = 300, 
        bbox_inches='tight',pad_inches=0
    )
    return fig, ax
#+END_SRC

#+RESULTS:
:results:
# Out [21]: 
:end:


*** Brazil: BRA
**** Energy share
    
#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
share = pd.read_excel(
    './raw/LCA/Consumo_Energia_EPE.xlsx',
    sheet_name='BR', 
    parse_dates=True,
    skiprows=11,
    usecols="A:F",
    index_col=[0],
)
#share = share[:-11] # Until March: Change here
share.index.name=''
share.index = pd.date_range(
    start = share.index[0],
    periods=share.shape[0],
    #end = share.index[-1],
    freq='M', 
)
share = share.apply(lambda x: x/share["TOTAL"]).drop(["TOTAL"], axis='columns')
share.columns = [
    "Comercial",
    "Residential",
    "Industrial",
    "Others"
]

fig, ax = plt.subplots(figsize=(8,5), dpi=300)

share["2019":].plot(
    ax=ax,
    kind='bar',
    stacked=True,
    edgecolor='black',
    lw=2
)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
ax.set_xticklabels(map(lambda x: line_format(x), share["2019":].index))


sns.despine()
plt.show()
share["Non-Residential"] = 1- share["Residential"]

#+END_SRC

#+RESULTS:
:results:
# Out [31]: 
# text/plain
: <Figure size 2400x1500 with 1 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/b9bb93431770d5b32665b50dc4549f5f948c88a6.png]]
:end:

**** Consumo Diário
     
#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py 
datelist = pd.date_range(
    start = "01/31/2018",
    end = str(dt.today().strftime("%m/%d/%Y")),
    freq='M',
).to_pydatetime().tolist()
datelist = [date.strftime("%Y_%m_%d") for date in datelist] #+ [str(dt.today().strftime("%Y_%m_%d"))]

bra = pd.DataFrame()

for date in datelist:
    url = f"http://sdro.ons.org.br/SDRO/DIARIO/{date}/HTML/07_DadosDiariosAcumulados_Regiao.html"
    bra = bra.append(pd.read_html(
        url,
        parse_dates=True,
        index_col = [0], skiprows=1, header=0, 
        thousands='.', #decimal=','
            )[0])
bra = bra[["Total"]] # TODO Check later: MWmed dia -> MW
bra.columns = ["BRA"]
bra.index = pd.date_range(
    start = bra.index[0],
    end = bra.index[-1],
    freq='D', 
)


energy_bra = bra.merge(share["2018":], left_index=True, right_index=True, how='left', ).fillna(method='ffill', ).fillna(method='bfill')
energy_bra["Daily Industrial"] = energy_bra["BRA"]*energy_bra["Industrial"]
energy_bra["Daily Non-Residential"] = energy_bra["BRA"]*energy_bra["Non-Residential"]
energy_bra["Daily Residential"] = energy_bra["BRA"]*energy_bra["Residential"]

country="Brazil"
units="MWmed"
days=365
fig, ax = plt.subplots(figsize=(8,5), dpi=300)
bra["2020":].plot(ax=ax, 
         ls='-', 
         title= f"Energy consumption for {country}\nTotal {units}",
         color='darkred'
        )
ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1, label='More than 60 COVID19 cases')
ax.legend()
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_level.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)


fig, ax = plt.subplots(figsize=(8,5), dpi=300)
bra.pct_change(days)["2020":].plot(ax=ax, 
         ls='-', 
         title= f"Energy consumption for {country}",
         color='red',
         label="Year over Year Growth rate",
         zorder=-1
        )
bra.pct_change(days).rolling(7).mean()["2020":].plot(ax=ax, 
         ls='--', 
         label="1 Week Moving average",
         color='black'
        )
ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1.5, label='More than 60 COVID19 cases')
ax.axvline(x = '2020-03-24', color='gray', ls='-', lw=1.5, label='Beginning of social isolation in SP')
ax.legend(labels=("YoY Growth rate", "1 Week Moving average", 'More than 60 COVID19 cases'))
ax.axhline(y=0, ls='--', color='black')

ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_growth.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)

infos['Country'].append("BRA")
infos["Type"].append('Demand') # Consumption not available
infos['Usage'].append(np.nan)
infos['Source'].append('All')
infos['Units'].append("MWmed")
infos['Frequency'].append('Dailly')
infos['Link'].append(url)


country="Brazil"
units="MWmed"
days=365
fig, ax = plt.subplots(figsize=(8,5), dpi=300)
energy_bra[["Daily Industrial"]].rolling(7).mean()["2020":].plot(ax=ax, 
         ls='-', 
         title= f"Industrial Energy consumption for {country}\n1 Week Moving Average",
         color='red'
        )
#ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1.5, label='More than 60 COVID19 cases')
ax.axvline(x = '2020-03-24', color='black', ls='-', lw=1.5, label='Beginning of social isolation in SP')
ax.legend()
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_level_Industrialshares.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)


fig, ax = plt.subplots(figsize=(8,5), dpi=300)
# energy_bra[["Daily Industrial"]].pct_change(days)["2020":].plot(ax=ax, 
#          ls='-', 
#          title= f"Industrial Energy consumption for {country}",
#          color='red',
#          label="Year over Year Growth rate",
#          zorder=-1
#         )
energy_bra[["Daily Industrial"]].pct_change(days).rolling(7).mean()["2020":].plot(ax=ax, 
         ls='-', 
         label="1 Week Moving average",
         title= f"Industrial Energy consumption for {country}\nYoY growth rate",
         color='red'
        )
#ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1.5, label='More than 60 COVID19 cases')
ax.axvline(x = '2020-03-24', color='black', ls='-', lw=1.5, label='Beginning of social isolation in SP')
ax.legend(labels=("YoY Growth rate\n1 Week Moving average", 'SP social isolation'))
ax.axhline(y=0, ls='-', color='black', lw=.7)

ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_growth_Industrialshares.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)


country="Brazil"
units="MWmed"
days=365
fig, ax = plt.subplots(figsize=(8,5), dpi=300)
energy_bra[["Daily Non-Residential"]].rolling(7).mean()["2020":].plot(ax=ax, 
         ls='-', 
         title= f"Consumo de energia não residencial\nMédia móvel de uma semana",
         color='red',
         label='Consumo diário'
        )
#ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1.5, label='More than 60 COVID19 cases')
ax.axvline(x = '2020-03-24', color='black', ls='-', lw=1.5, label='Início do isolamento social em SP')
ax.legend(labels=("Consumo diário\nSemana Móvel", 'Início do Isolamento social em SP'))
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_level_Non-Residentialshares.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)


fig, ax = plt.subplots(figsize=(8,5), dpi=300)
# energy_bra[["Daily Non-Residential"]].pct_change(days)["2020":].plot(ax=ax, 
#          ls='-', 
#          title= f"Non-Residential Energy consumption for {country}",
#          color='red',
#          label="Year over Year Growth rate",
#          zorder=-1
#         )
energy_bra[["Daily Non-Residential"]].pct_change(days).rolling(7).mean()["2020":].plot(ax=ax, 
         ls='-', 
         title= f"Consumo não-residencial de energia\nTaxa de Crescimento YoY (semana móvel)",
         label="1 Week Moving average",
         color='red'
        )
#ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1.5, label='More than 60 COVID19 cases')
ax.axvline(x = '2020-03-24', color='black', ls='-', lw=1.5, label='Beginning of social isolation in SP')
ax.legend(labels=("Taxa de crescimento YoY\nSemana Móvel", 'Início do Isolamento social em SP'))
ax.axhline(y=0, ls='-', color='black', lw=.7)

ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/Energia/DailyEnergyConsumption_{country}_{units}_growth_Non-Residentialshares.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)

#+END_SRC

#+RESULTS:
:results:
# Out [23]: 
# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/77baa432ba2f44632060c841842355fcb8b83c23.png]]

# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/d4289bac917b4c3c16dd2a44f65ca09392f8c087.png]]

# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/bc952cb86ebe11930cccbfae0ee09821adb7b9c0.png]]

# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/f9ca7a33a86e705f7a59435db0037a8fc525f9eb.png]]

# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/3f4b22b7fe301e9d040661b4ccbfccd82d0f77ff.png]]

# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/862628f923a3fda24d4e664ce8bc872a805019fe.png]]
:end:




*** France: FRA

#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
url = 'https://www.data.gouv.fr/en/datasets/r/cfc27ff9-1871-4ee8-be64-b9a290c06935'
fra = pd.read_csv(
    url,
    sep = ';',
    #'../data/Energy/FRA.csv',
    usecols=['Date - Heure', 'Date', 'Heure', 'Consommation brute totale (MW)'],
    index_col=['Date'], 
    parse_dates=True, dayfirst=True, # Check
    #thousands=',' # Check
)
fra = fra.sort_values(by='Date - Heure').drop('Date - Heure', axis='columns')
fra.reset_index(inplace=True)
fra = (fra.groupby(by='Date').mean())
fra = fra[['Consommation brute totale (MW)']]
fra = fra["2020":]#/1000 # Check later
fra = fra.dropna()
fra.columns = ["FRA"]
fra.index.name=''
fra.to_csv('./raw/Energy/FRA.csv')

ploter(
    df=fra, 
    country="France", 
    days = 7,
    units="MW"
)

infos['Country'].append("FRA")
infos["Type"].append('Consumption')
infos['Usage'].append(np.nan)
infos['Source'].append('All')
infos['Units'].append("MW")
infos['Frequency'].append('halfhour')
infos['Link'].append(url)

#+END_SRC

#+RESULTS:
:results:
# Out [24]: 
# output
<ipython-input-21-06392b792fc4>:74: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()

# text/plain
: <Figure size 2400x1500 with 4 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/325746abff053090d5f6fe9490ccdb4ba397472d.png]]
:end:

*** Spain: Spain

*Corrigir*

#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
datelist = pd.date_range(
    start = "01/01/2020",
    end = str((dt.today()- timedelta(days=2)).strftime("%d/%m/%Y")),
    freq='D', 
).to_pydatetime().tolist()

spa = pd.DataFrame()
for day in datelist:
    #url = f'https://demanda.ree.es/visiona/peninsula/demanda/tablas/{day:%Y-%m-%d}/1'
    url = f"https://apidatos.ree.es/es/datos/demanda/demanda-tiempo-real?start_date={day:%Y-%m-%d}T00:00&end_date={(day + timedelta(days=2)):%Y-%m-%d}T01:00&time_trunc=hour"
    response=requests.request(url=url, method='get')
    data=response.json()
    value = pd.DataFrame(
    data['included'][0]['attributes']['values'],
        )
    value = value[['value']].rolling(6).sum()
    value = value[['value']].mean() # Unity: MW
    value = pd.DataFrame({
    'ESP': value,
    'Date': [day.strftime("%Y-%m-%d")]
    },)
    value['Date'] = pd.to_datetime(value['Date'])
    value = value.set_index('Date')
    value.index.name=''
    spa = spa.append(value)
spa.to_csv('./raw/Energy/ESP.csv')

ploter(
    df=spa, 
    country="Spain", 
    days = 7,
    units="MW"
)

infos['Country'].append("ESP")
infos["Type"].append('Consumption')
infos['Usage'].append(np.nan)
infos['Source'].append('All')
infos['Units'].append("MW")
infos['Frequency'].append('10 minutes')
infos['Link'].append(url)

#+END_SRC

#+RESULTS:
:results:
# Out [35]: 
# output
<ipython-input-21-06392b792fc4>:74: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()

# text/plain
: <Figure size 2400x1500 with 4 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/aa615addfd95d863842bc30c5c6c024b67813166.png]]
:end:

*** Austria: AUS

#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
aus = pd.read_csv(
    './raw/Energy/AUS.csv', 
    sep=';', 
    index_col=["Date", "Time of day"], 
    parse_dates=True, 
    thousands=',', decimal='.'
)
sources = ['Biomass[MWh]', 'Hydropower[MWh]', 
                       'Wind onshore[MWh]', 'Photovoltaics[MWh]',
                       'Other renewable[MWh]', 'Fossil hard coal[MWh]',
                       'Fossil gas[MWh]', 'Hydro pumped storage[MWh]',
                       'Other conventional[MWh]'
                      ]

#aus[sources] = aus[sources].apply(pd.to_numeric, errors='coerce') 
aus["Total[MWh]"] = aus["Total[MWh]"].str.replace(',', '')
aus["Total[MWh]"] = pd.to_numeric(aus["Total[MWh]"], errors='coerce')
aus["Total[MWh]"] = aus["Total[MWh]"]*(4) # TODO Check later: MWh -> MW
#aus["Total[MWh]"] = aus["Total[MWh]"].rolling(4).mean() # TODO Check later: MWhmed
aus = aus.groupby(by='Date', sort=False).mean()
aus = aus[["Total[MWh]"]]
aus.index.name = ''
aus.columns = ["AUS"]
df_ = aus.copy()

infos['Country'].append("AUS")
infos["Type"].append('Consumption')
infos['Usage'].append(np.nan)
infos['Source'].append("All")
infos['Units'].append("Total[MWh]")
infos['Frequency'].append('Quarterhour')
infos['Link'].append(np.NaN)

ploter(
    df=aus, 
    country="Austria", 
    days = 7,
    units="MWh"
)
#+END_SRC

#+RESULTS:
:results:
# Out [28]: 
# output
<ipython-input-21-06392b792fc4>:74: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()

# text/plain
: (<Figure size 2400x1500 with 4 Axes>,
:  array([<matplotlib.axes._subplots.AxesSubplot object at 0x7f69c9727190>,
:         <matplotlib.axes._subplots.AxesSubplot object at 0x7f69cbec3400>],
:        dtype=object))

# text/plain
: <Figure size 2400x1500 with 4 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9ef112a5872cc34e81a6bb8ef5d1a8c7b5fddf8e.png]]
:end:

*** Germany: GER

#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
ger = pd.read_csv(
    './raw/Energy/GER.csv', 
    sep=';', 
    index_col=["Date", "Time of day"], 
    parse_dates=True, 
    thousands=',', decimal='.', 
)
sources = ['Biomass[MWh]', 'Hydropower[MWh]', 
                       'Wind onshore[MWh]', 'Photovoltaics[MWh]',
                       'Other renewable[MWh]', 'Fossil hard coal[MWh]',
                       'Fossil gas[MWh]', 'Hydro pumped storage[MWh]',
                       'Other conventional[MWh]'
                      ]

#ger[sources] = ger[sources].apply(pd.to_numeric, errors='coerce') 
ger["Total[MWh]"] = ger["Total[MWh]"].str.replace(',', '')
ger["Total[MWh]"] = pd.to_numeric(ger["Total[MWh]"], errors='coerce')
ger["Total[MWh]"] = ger["Total[MWh]"]*(4) # TODO Check later: MWh -> MW
#ger["Total[MWh]"] = ger["Total[MWh]"].rolling(4).mean() # TODO Check later: MWhmed
ger = ger.groupby(by='Date', sort=False).mean()
ger = ger[["Total[MWh]"]]
ger.index.name = ''
ger.columns = ["GER"]

ploter(
    df=ger, 
    country="Germany", 
    days = 7,
    units="MWh"
)

infos['Country'].append("GER")
infos["Type"].append('Consumption')
infos['Usage'].append(np.nan)
infos['Source'].append("All")
infos['Units'].append("Total[MWh]")
infos['Frequency'].append('Quarterhour')
infos['Link'].append(np.NaN)

#+END_SRC

#+RESULTS:
:results:
# Out [29]: 
# output
<ipython-input-21-06392b792fc4>:74: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()

# text/plain
: <Figure size 2400x1500 with 4 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/94b114813ade8f5d4312e2e75f5b997a956c4a44.png]]
:end:

*** Luxemburg: LUX
    
#+BEGIN_SRC ipython :session Energia :tangle ./codes/Energia.py
lux = pd.read_csv(
    './raw/Energy/LUX.csv', 
    sep=';', 
    index_col=["Date", "Time of day"],  
    thousands=',', decimal='.',
    parse_dates=True
)
lux["Total[MWh]"] = lux["Total[MWh]"].str.replace(',', '')
lux["Total[MWh]"] = pd.to_numeric(lux["Total[MWh]"], errors='coerce')
lux["Total[MWh]"] = lux["Total[MWh]"]*(4) # TODO Check later: MWh -> MW
#lux["Total[MWh]"] = lux["Total[MWh]"].rolling(4).mean() # TODO Check later: MWhmed
lux = lux.groupby(by='Date', sort=False).mean()
lux.index.name = ''
lux.columns = ["LUX"]

ploter(
    df=lux, 
    country="Luxembourg", 
    days = 7,
    units="MWh"
)

infos['Country'].append("LUX")
infos["Type"].append('Consumption') # Production not available
infos['Usage'].append(np.nan)
infos['Source'].append(np.nan)
infos['Units'].append("MWh")
infos['Frequency'].append('Quarterhour')
infos['Link'].append(np.NaN)
#+END_SRC

#+RESULTS:
:results:
# Out [26]: 
# output
<ipython-input-21-06392b792fc4>:74: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()

# text/plain
:                    LUX
:                       
: 2019-01-01  395.145833
: 2019-01-02  113.833333
: 2019-01-03    0.000000
: 2019-01-04  122.604167
: 2019-01-05  366.916667
: ...                ...
: 2020-08-19  395.208333
: 2020-08-20  476.333333
: 2020-08-21  414.705882
: 2020-08-22         NaN
: 2020-08-23         NaN
: 
: [601 rows x 1 columns]

[[file:/tmp/ob-ipython-html5ql3zW.html]]

# text/plain
: <Figure size 2400x1500 with 4 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9106e308f42f1f76c029539778f3952a7f562f15.png]]
:end:


** Aruoba-Diebold-Scotti Business Conditions Index

#+BEGIN_SRC ipython :session ADS :tangle ./codes/ADS.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import matplotlib.dates as mdates
import matplotlib.ticker as ticker
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/USA/'
image_path = './figs/USA/'
corona = '2020-03-18' # More than 60 cases in Brazil
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [2]: 
:end:

#+BEGIN_SRC ipython :session ADS :tangle ./codes/ADS.py
df = pd.read_excel(
    'https://www.philadelphiafed.org/-/media/research-and-data/real-time-center/business-conditions-index/ads_index_most_current_vintage.xlsx?la=en',
    index_col=[0], parse_dates = True
)

fig, ax = plt.subplots(figsize=(8,5), dpi=300)

df["2019-01-01":"2020-08-31"].plot(ax=ax, 
         ls='-', 
         title= "Aruoba-Diebold-Scotti Business Conditions Index",
         color='darkred'
        )
ax.axvline(x = '2020-03-18', color='black', ls='-', lw=1, label='More than 60 COVID19 cases')
ax.legend()
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()
fig.savefig(
    f"./figs/USA/ADS.svg", 
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
)
#+END_SRC

#+RESULTS:
:results:
# Out [6]: 
# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/cf14fa691a64e7d5e47f44565dc9f5363854ad6e.png]]
:end:

* Confiança, Indicadores de antecedentes e de Risco

** Confiança

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/Confianca/'
corona_sp = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [89]: 
:end:

*** Sondagem Conjuntural Mensal

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
file_name = 'Sondagem_Conjuntural_Mensal_FGV'
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name='Com Ajuste CNAE 2.0', 
    parse_dates=True,
    index_col=[0], 
    skiprows=10,
    na_values = '-'
)[1:][start_year:]
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.drop(['NUCI'], axis='columns').plot(
    title = file_name.replace('_', ' '),
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [90]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/7b3e58a37abae00e5e3eb5c1240536addcb36229.png]]
:end:

*** Sondagens de serviços

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
file_name = 'Sondagem_Servicos_FGV'
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name='ICS_dessaz', 
    parse_dates=True,
    index_col=[0], 
    skiprows=10,
    na_values = '-',
)[1:][start_year:]
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.drop(['Índice de Confiança de Serviços (ICS) .1', 'NUCI'], axis='columns').plot(
    title = file_name.replace('_', ' '),
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [91]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/aa0dc5316591c59e078ea9eb54ee5d1847c03529.png]]
:end:


*** Sondagem do comércio

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
file_name = 'Sondagem_do_Comercio_FGV'
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name='dessaz CNAE 2.0', 
    parse_dates=True,
    index_col=[0], 
    skiprows=11,
    na_values = '-',
)
df.index = pd.date_range( # Check for NaN
    start = '2010-03-01',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df.index.name = ''
df = df[start_year:]
    
fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = file_name.replace('_', ' '),
    ax = ax,
    lw = 2.5
)
ax.axvline(x = "2020-04-01", 
           color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)', )
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [92]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/554f61127530cd8c56d7d2bb715c64b18b66079b.png]]
:end:

*** Sondagem da construção

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
file_name = 'Sondagem_Construcao_FGV'
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name='Com ajuste CNAE 2.0', 
    parse_dates=True,
    index_col=[0], 
    skiprows=10,
    na_values = '-',
)[1:][start_year:]
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.drop(['NUCI'], axis='columns').plot(
    title = file_name.replace('_', ' '),
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [93]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/5c55149be31444f847711890239c1aa99b605e4e.png]]
:end:

*** Sondagem industrial CNI

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
agregadas = [
    'Total',
    'Ind. Extrativa',
    'Ind. de Transformação'
]
def importer(sheet='Volume Produção', skip_rows=10, initial=1):
    file_name = 'Sondagem_Industrial_CNI'
    df = pd.read_excel(
        file_path + file_name + '.xlsx', 
        sheet_name=sheet, 
        parse_dates=True,
        index_col=[0], 
        skiprows=skip_rows, na_values='-'
    )[initial:][start_year:]
    df.index = pd.to_datetime(df.index, format="%Y-%m")
    df.index.name = ''
    return df

file_name = 'Sondagem_Industrial_CNI'
#+END_SRC

#+RESULTS:
:results:
# Out [94]: 
:end:

**** Volume de produção

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Volume Produção'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [95]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/38f547e28e64d3a45c6d27a727a62aa301d80753.png]]
:end:

**** Evolução do Emprego

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Evolução Empr'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [96]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/f37059e5663a6183f7323a2bea6f3b8ed9dba88f.png]]
:end:


**** NUCI

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='NUCI'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [97]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/168c9d12b41c7ac07608ad8d75414f133fd99cf6.png]]
:end:

**** NUCI Efeito-Usual

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='NUCI Efetivo-Usual'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [98]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/7a0bc786fc2b366f513e486fa9da04f995e06c54.png]]
:end:

**** Evolução de estoques

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Evolução Estoques'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [99]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/fd32fd3f47edd7d6ff75dd215a315cbf0b037f86.png]]
:end:

**** Estoques efetivos

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Estoques Efetivos'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [100]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/1cd65f04161dcd94829a4e8d585f9e9c2038b23e.png]]
:end:

**** Expectativa de Demanda

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Expec Demanda'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [101]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/d175d203a1e0fa24dab98a4cc430d67b312fc504.png]]
:end:

**** Expectativa de Exportação

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Expec Exportação'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [102]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9b4f75ae5dfbd3b780483f3ba4e18217227ba501.png]]
:end:

**** Expectativa de compra de matéria-prima


#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Expec Compra Mat. Prima'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [103]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/cc12013aec1a7595bfa8d41ae3d6896fb2a84060.png]]
:end:

**** Expectativa de emprego

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Expec Emprego'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [104]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/8c83f58d6340a55e998ad231fb16037ce6828c59.png]]
:end:

**** Expectativa de investimento

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Expec Investimento'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [105]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/b0bc7180843da18ade4ca5c8b9ba738f9a5ebd32.png]]
:end:

**** Lucro Operacional


#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
agregadas = [
    'Total',
    'Ind. Extrativa',
    'Ind. de Transformação'
]
def importer(sheet='Lucro Operacional', skip_rows=10, initial=1):
    file_name = 'Sondagem_Industrial_CNI'
    df = pd.read_excel(
        file_path + file_name + '.xlsx', 
        sheet_name=sheet, 
        parse_dates=True,
        index_col=[0], 
        skiprows=skip_rows, na_values='-'
    )[initial:]
    df.index = pd.date_range(
    start = '2007-07-31',
    periods=df.shape[0],
    freq='Q', 
    )
    df.index.name = ''
    return df
#+END_SRC

#+RESULTS:
:results:
# Out [106]: 
:end:


#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Lucro Operacional'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas]["2019-01-01":].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [107]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/82d95fa798d4ba22575a10087adf5c823956433e.png]]
:end:

**** Situação Financeira

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Situação Financeira'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [108]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/bf403eed7affd3cdac032cea98157acdb3c29b05.png]]
:end:


**** Acesso a Crédito

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
sheet='Acesso Crédito'
df = importer(sheet=sheet, initial=1, skip_rows=11)
df.columns = ['Total' if coluna == "Unnamed: 1" else coluna for coluna in df.columns]

fig, ax = plt.subplots(figsize=(8,5))
df[agregadas].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [109]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/d8b87eca93910a125a0efab8c3c2d1ff4bc1d07b.png]]
:end:

** Indicadores de antecedente

*** Composite Leading index ([[https://stats.oecd.org/Index.aspx?DataSetCode=MEI_CLI][CLI]])

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
import pandas_datareader.data as web
import requests
import json

import country_converter as coco
cc = coco.CountryConverter()

df = web.DataReader(
    'MEI_CLI', # https://stats.oecd.org/Index.aspx?DataSetCode=MEI_CLI
    'oecd', 
    start='2007-01-01'
)
type = [
    "Original, seasonally adjusted (GDP)",
    #"Amplitude adjusted (CLI)",
    #"Normalised (CLI)",
    #"Normalised (GDP)",
    #"Trend restored (CLI)",
]
df = df.transpose().loc[(
    type[0]
),:]
df = df.reset_index()
df = df[df["Frequency"] == "Monthly"].drop(["Frequency"], axis='columns')
df = df.transpose()
df.columns = cc.convert(names = list(df.loc["Country"]), to = 'ISO3', not_found=None) # To avoid string problems
df.columns.name = ''
df.drop(['Country'], inplace=True)
df.index.name = ''
df.index = pd.date_range(
    start = df.index[0],
    end = f"{str(df.index[-1])[:6]}{int(str(df.index[-1])[6])+1}{str(df.index[-1])[7:]}",
    freq='M', 
)
df.to_csv('./raw/Dados de Confiança/CLI.csv')

cases = ["USA", "ESP", "ITA", "G7", "OECD total "]
source = f"Source: OECD\nLast query: {dt.today():%d/%m/%y}"

fig, ax = plt.subplots(figsize=(8,5))

df['2018':][cases].plot(ax=ax, lw=2)
df['2018':][["BRA"]].plot(ax=ax, lw=3, color='darkred',)
ax.set_title(f"Composite Leading Indicators (MEI)\n{type[0]}", fontweight='bold')
fig.text(0.79, .28, source, ha='left')
ax.axvline(x='2020-03-18', label='More than 60\ncases in Brazil',
           ls='--', color='black', lw=1.5, )
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

plt.tight_layout()
sns.despine()
plt.show()
#+END_SRC

#+RESULTS:
:results:
# Out [110]: 
# output
WARNING:root:OECD + Major Six NME not found in regex
WARNING:root:Major Five Asia not found in regex
WARNING:root:Four Big European not found in regex
WARNING:root:G7 not found in ISO2
WARNING:root:NAFTA not found in regex
WARNING:root:OECD - Total not found in regex
WARNING:root:OECD - Europe not found in regex
WARNING:root:Euro area (19 countries) not found in regex
WARNING:root:OECD total  not found in regex

# text/plain
: <Figure size 576x360 with 1 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9bcf6d9f78953ccf19a8f910062819f29e1f69ea.png]]
:end:


*** Consumer Confidence index ([[https://stats.oecd.org/Index.aspx?DataSetCode=MEI_CCI][CCI]])

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
df = web.DataReader(
    'MEI_CLI', # https://stats.oecd.org/Index.aspx?DataSetCode=MEI_CCI
    'oecd', 
    start='2007-01-01'
)
df = df.transpose().loc[(
    'OECD Standardised CCI, Amplitude adjusted (Long term average=100), sa',
    #"Normalised (CLI)",
    #"Normalised (GDP)",
    #"Trend restored (CLI)",
),:]
df = df.reset_index()
df = df[df["Frequency"] == "Monthly"].drop(["Frequency"], axis='columns')
df = df.transpose()
df.columns = cc.convert(names = list(df.loc["Country"]), to = 'ISO3', not_found=None) # To avoid string problems
df.columns.name = ''
df.drop(['Country'], inplace=True)
df.index.name = ''
df.index = pd.date_range(
    start = df.index[0],
    end = f"{str(df.index[-1])[:6]}{int(str(df.index[-1])[6])+1}{str(df.index[-1])[7:]}",
    freq='M', 
)
df.to_csv('./raw/Dados de Confiança/CCI.csv')


cases = ["USA", "ESP", "ITA", "G7", "OECD total "]
source = f"Source: OECD\nLast query: {dt.today():%d/%m/%y}"

fig, ax = plt.subplots(figsize=(8,5))

df['2019':][cases].plot(ax=ax, lw=2)
df['2019':][["BRA"]].plot(ax=ax, lw=3, color='darkred',)
ax.set_title("Índice de Confiança do Consumidor (CCI)", fontweight='bold')
fig.text(0.79, .28, source, ha='left')
ax.axvline(x='2020-03-24', label='Início do Isolamento em SP',
           ls='--', color='black', lw=1.5, )
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
plt.tight_layout()
sns.despine()
plt.show()
#+END_SRC

#+RESULTS:
:results:
# Out [111]: 
# output
/home/gpetrini/.local/lib/python3.8/site-packages/pandas/core/indexing.py:1762: PerformanceWarning: indexing past lexsort depth may impact performance.
  return self._getitem_tuple(key)
WARNING:root:OECD + Major Six NME not found in regex
WARNING:root:Major Five Asia not found in regex
WARNING:root:Four Big European not found in regex
WARNING:root:G7 not found in ISO2
WARNING:root:NAFTA not found in regex
WARNING:root:OECD - Total not found in regex
WARNING:root:OECD - Europe not found in regex
WARNING:root:Euro area (19 countries) not found in regex
WARNING:root:OECD total  not found in regex

# text/plain
: <Figure size 576x360 with 1 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/f68f8b6cb09da9311b88232927b50a8f0f94cb40.png]]
:end:

** Risco
   
*** EMBI+ (JP Morgan)

#+BEGIN_SRC ipython :session Confianca :tangle ./codes/Confianca.py
file_name = 'embiplus'
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name='EMBI', 
    parse_dates=True,
    index_col=[0], 
    skiprows=11,
    na_values = '-',
)[1:][start_year:]
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
df = df[[
#    "Argentina",
    "Brasil",
    "Europa",
    "Latin",
    "Rússia",
    "China",
    "Coréia do Sul",
]]
fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "EMBI+ (JP Morgan)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Início do isolamento em SP\n(24 de março)')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [112]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/c50dfc43d174b7c73e73e951c62430709a829874.png]]
:end:


** Incerteza

#+BEGIN_SRC ipython :session Incerteza :tangle ./codes/Incerteza.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/Confianca/'
corona_sp = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [2]: 
:end:


*** Indicador de Incerteza (IIE-Br)

#+BEGIN_SRC ipython :session Incerteza :tangle ./codes/Incerteza.py
file = "IIE-Br_FGV"
df = pd.read_excel(
    f"{file_path + file}.xlsx",
    index_col=[0],
    skiprows=11,
    parse_dates=True
)
df.index.name = ''
df = df["2019-01-01":]

fig, ax = plt.subplots(figsize=(8,5), dpi=300)

df.plot(
    ax=ax,
    title = "Indicador de Incerteza (IIE-Br)")

ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + file +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )


#+END_SRC

#+RESULTS:
:results:
# Out [6]: 
# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/c5efa72595cc12bf613b1062622f61c3df58ecab.png]]
:end:


*** Indicador de Confiança Empresarial

#+BEGIN_SRC ipython :session Incerteza :tangle ./codes/Incerteza.py
file = "ICE_FGV"
df = pd.read_excel(
    f"{file_path + file}.xlsx",
    index_col=[0],
    skiprows=11,
    parse_dates=True,
    sheet_name='Com_ajuste'
)
df.index.name = ''
df = df["2019-01-01":]

fig, ax = plt.subplots(figsize=(8,5), dpi=300)

df.plot(
    ax=ax,
    title = "Indicador de Confiança Empresaria (ICE-FGV)")

ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + file +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )


#+END_SRC

#+RESULTS:
:results:
# Out [8]: 
# text/plain
: <Figure size 2400x1500 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/8e38298178125842685b068036bdce559fd6ab01.png]]
:end:

* Atividade
  
** Crédito

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/Credito/'
corona_sp = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
corona = '2020-03-18' # More than 60 cases in Brazil
start_year = "2019-01-01"
file_name = 'Indicadores_de_Credito_Bacen'
def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
#ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#+END_SRC

#+RESULTS:
:results:
# Out [27]: 
:end:

*** Saldo

**** Pessoa jurídica

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoPJ"
titulo = "Saldo Pessoa jurídica"
porcentagem=False
unidade="Milhões"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,Z,AM", 
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.2%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [28]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/402de444762880e51b3a602c504b7e8d63732349.png]]
:end:


#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoPJ"
titulo = "Saldo Pessoa jurídica"
porcentagem=False
unidade="Milhões"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,Z,AM", 
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.pct_change(12)[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [29]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/8ade2681015bf89863078900a6d91c53bd592f3b.png]]
:end:

**** Pessoa física

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoPF"
titulo = "Saldo Pessoa física"
porcentagem=False
unidade="Milhões"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,W,AJ", 
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.2%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [30]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/c5ebb89c192628d7cec923eb13d6356df012028a.png]]
:end:

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoPF_%PIB"
titulo = "Saldo Pessoa física\nem % PIB"
porcentagem=True
unidade="PIB"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,W,AJ", 
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.2%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [31]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/b694dfa6b6aa8de15c823bc95e21ec965d607fee.png]]
:end:

**** Crédito ampliado

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoCréditoAmpliado"
titulo = "Saldo Crédito Ampliado"
porcentagem=True
unidade="do Total"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,N,V,AJ", 
)[0:]
df.columns = [
    "Setor não financeiro",
    "Governo Geral",
    "Empresas e Famílias"
]
df.index = pd.date_range( # Check for NaN
    start = '2013-01-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
df["Total"] = df.sum(axis=1)
df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [32]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/fc25f4901d8007b52b37c8cc10e4620bc37873f2.png]]
:end:

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoCréditoAmpliado"
titulo = "Saldo Crédito Ampliado"
porcentagem=False
unidade="Milhões"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,N,V,AJ", 
)[0:]
df.columns = [
    "Setor não financeiro",
    "Governo Geral",
    "Empresas e Famílias"
]
df.index = pd.date_range( # Check for NaN
    start = '2013-01-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
#df["Total"] = df.sum(axis=1)
#df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    #kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [33]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/285a93936f0519f57c3f51e4597e9bc013c3ab1a.png]]
:end:


#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoCréditoAmpliado_%PIB"
titulo = "Saldo Crédito Ampliado"
porcentagem=True
unidade="PIB"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,N,V,AJ", 
)[0:]
df.columns = [
    "Setor não financeiro",
    "Governo Geral",
    "Empresas e Famílias"
]
df.index = pd.date_range( # Check for NaN
    start = '2013-01-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
#df["Total"] = df.sum(axis=1)
#df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    #kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +   '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [34]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/71e2f6f170d1eae4c7e08b6bb69381e2fc6bfa43.png]]
:end:

**** Crédito direcionado


#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoDirecionado"
titulo = "Saldo Crédito Direcionado"
porcentagem=False
unidade="Milhões"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,D,G,,K,L", 
)[0:]
df.columns = [
    "Rural",
    "Financiamento Imobiliário",
    "BNDES",
    "Outros"
]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    #kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
#ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.2f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [35]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/8e80f62dee7a7da5353be6056c7d954dc453835e.png]]
:end:

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoDirecionado"
titulo = "Saldo Crédito Direcionado"
porcentagem=True
unidade="do Total"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,D,G,,K,L", 
)[0:]
df.columns = [
    "Rural",
    "Financiamento Imobiliário",
    "BNDES",
    "Outros"
]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
df["Total"] = df.sum(axis=1)
df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')


df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.2f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [36]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9a2b55ba48387fe773ae71f452b084dae90c5a91.png]]
:end:

#+BEGIN_SRC ipython :session Credito :tangle ./codes/Credito.py
sheet = "SaldoDirecionado_%PIB"
titulo = "Saldo Crédito Direcionado"
porcentagem=True
unidade="PIB"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    usecols="A,D,G,,K,L", 
)[0:]
df.columns = [
    "Rural",
    "Financiamento Imobiliário",
    "BNDES",
    "Outros"
]
df.index = pd.date_range( # Check for NaN
    start = '2007-03-31',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M', 
    #periods=(1241-12)
    )
df = df[start_year:]
# df["Total"] = df.sum(axis=1)
# df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')


df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    #kind='bar', stacked=True, edgecolor='black',
    lw=2, 
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.2f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + sheet.replace(' ', '') + unidade +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [37]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/9d5911f91378331c30c8ae9b513d4af5c47cd126.png]]
:end:



** IBCBr

#+BEGIN_SRC ipython  :session ibcbr :tangle ./codes/ibcbr.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/IBCBr.xlsx'
image_path = './figs/Antecedente/'
corona = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [3]: 
:end:


#+BEGIN_SRC ipython  :session ibcbr :tangle ./codes/ibcbr.py
df = pd.read_excel(
    file_path,
    sheet_name = "IBC-Br Dessaz",
    skiprows = 11,
#    usecols = "A:B",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]


fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Índice de Atividade Econômica do Banco Central\nDessazonalizado",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + "IBCBr" + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [5]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/867e8a85521aa7667c388ddb9c5027a1ada952bb.png]]
:end:

** PIB (Contas Nacionais)

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.ticker import FuncFormatter
import matplotlib.dates as mdates
import seaborn as sns
import datetime

plt.style.use('seaborn-dark-palette')

import matplotlib.image as image

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)
#+END_SRC

#+RESULTS:
:results:
# Out [17]: 
:end:

#+BEGIN_SRC sh :dir ./raw/ContasNacionais/
wget -N --backups=1 ftp://ftp.ibge.gov.br/Contas_Nacionais/Contas_Nacionais_Trimestrais/Tabelas_Completas/Tab_Compl_CNT.zip
unzip -o Tab_Compl_CNT.zip
mv *.xls Tab_Compl_CNT.xlsx
#+END_SRC

#+RESULTS:
:results:
Archive:  Tab_Compl_CNT.zip
  inflating: Tab_Compl_CNT_1T20.xls  
:end:

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
Colunas = [
    "Agropecuaria",
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria",
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
    "VA",
    "PIB",
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Agropecuaria = ['Agropecuaria']

Industria = [
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria"
]

Servicos = [
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
]

Demanda = [
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Oferta = [
    'Agropecuaria',
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Val encad preços 95 com ajuste', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
#+END_SRC

#+RESULTS:
:results:
# Out [20]: 
:end:

*** Trimestre Contra trimestre imediatamente anterior

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig = plt.figure(figsize=(9,4))
ax = plt.axes()
ax2 = plt.axes([0.15,0.6,0.2,0.2])

suptitle = 'Taxa de crescimento'
title = 'Trimestre contra trimestre anterior'


df['PIB'].pct_change().tail(4).plot(kind='bar', ax=ax, color='darkblue')
ax.axhline(y=0, ls='--', color='black')

plt.suptitle(suptitle, color='black', weight = 'bold')
ax.set_title(title, color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
sns.set_style('white')
fig.savefig('./figs/PIB/PIB.png')
plt.show()

print(df['PIB'].pct_change().tail(4))
#+END_SRC

#+RESULTS:
:results:
# Out [22]: 
# output
2019Q2    0.005406
2019Q3    0.004618
2019Q4    0.003655
2020Q1   -0.015394
Freq: Q-DEC, Name: PIB, dtype: float64

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/ae1515a7b487b55149c37fa44d319f5deb1387b7.png]]
:end:

**** Agropecuária

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Agropecuaria].pct_change().tail(4).plot(kind='bar', ax=ax, color='darkblue')

plt.suptitle('Agricultura', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

fig.savefig('./figs/PIB/Agropecuaria.png')
plt.show()
#+END_SRC

#+RESULTS:
:results:
# Out [23]: 
# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/3567d5d74a87a0022c1b5d021b8202e9643e9c6d.png]]
:end:

**** Indústria

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Industria].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Indústria', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Industria.png')

print(df[Industria].pct_change().tail(4))
#+END_SRC

#+RESULTS:
:results:
# Out [24]: 
# text/plain
:         Industria Extrativa  Industria de Transformacao  Eletricidade e agua  \
: 2019Q2            -0.030796                    0.015653            -0.004612   
: 2019Q3             0.112907                   -0.008735            -0.013919   
: 2019Q4             0.006668                    0.001203             0.002735   
: 2020Q1            -0.032339                   -0.013738            -0.001341   
: 
:         Construcao  Total Industria  
: 2019Q2    0.019130         0.006188  
: 2019Q3    0.008864         0.007511  
: 2019Q4   -0.023357         0.000195  
: 2020Q1   -0.023948        -0.013793  

[[file:/tmp/ob-ipython-html6Ut6v0.html]]

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/bc5997d911634acc1c7a406cdbacc62dba75ab6a.png]]
:end:


**** Serviços

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Servicos].pct_change().tail(4).plot(kind='bar', ax=ax)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


plt.suptitle('Serviços', color='black', weight = 'bold')

ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Servicos.png')

print(df[Servicos].pct_change())
#+END_SRC

#+RESULTS:
:results:
# Out [25]: 
# output
        Comercio  Transporte, armazenagem e correio  Informacao e comunicacao  \
1996Q1       NaN                                NaN                       NaN   
1996Q2 -0.002371                          -0.028222                  0.015095   
1996Q3  0.025455                           0.036438                  0.021967   
1996Q4  0.015195                          -0.037310                 -0.001976   
1997Q1  0.002414                           0.040428                  0.011012   
...          ...                                ...                       ...   
2019Q1  0.008961                          -0.002449                  0.011049   
2019Q2  0.006977                          -0.000455                  0.006743   
2019Q3  0.007517                          -0.003686                  0.010703   
2019Q4 -0.001857                           0.014547                  0.016215   
2020Q1 -0.007686                          -0.024192                 -0.019052   

        Atividades Financeiras  Atividades Imobiliarias  Outras atividades  \
1996Q1                     NaN                      NaN                NaN   
1996Q2                0.001748                 0.006362          -0.005097   
1996Q3               -0.000033                 0.009057           0.002842   
1996Q4               -0.087280                -0.024478          -0.003531   
1997Q1                0.110854                 0.022929           0.014299   
...                        ...                      ...                ...   
2019Q1                0.008045                 0.003100           0.001185   
2019Q2               -0.000677                 0.007525           0.003958   
2019Q3                0.013945                 0.002887           0.000598   
2019Q4                0.008249                 0.001962           0.008319   
2020Q1               -0.001175                 0.003511          -0.045997   

        ADM, defesa, etc  Total Servicos  
1996Q1               NaN             NaN  
1996Q2          0.008730        0.003606  
1996Q3          0.005202        0.016645  
1996Q4         -0.006725       -0.023475  
1997Q1         -0.000029        0.021750  
...                  ...             ...  
2019Q1          0.004140        0.003870  
2019Q2         -0.002328        0.002439  
2019Q3         -0.007317        0.003180  
2019Q4          0.010108        0.006761  
2020Q1         -0.004807       -0.016362  

[97 rows x 8 columns]

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/16f20c74bddf18148bdc452e51837900c45e4ce3.png]]
:end:

**** Demanda

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Demanda + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Demanda.png')

print(df[Demanda + ['PIB']].pct_change().tail(4))
#+END_SRC

#+RESULTS:
:results:
# Out [26]: 
# output
        Consumo das Familias  Consumo do Governo      FBCF  Exportacao  \
2019Q2              0.004122           -0.002895  0.024859   -0.023292   
2019Q3              0.004586           -0.003876  0.017226   -0.023973   
2019Q4              0.004198            0.004176 -0.026872    0.022656   
2020Q1             -0.019856            0.002393  0.030928   -0.009145   

        Importacao       PIB  
2019Q2    0.014682  0.005406  
2019Q3    0.024805  0.004618  
2019Q4   -0.033197  0.003655  
2020Q1    0.028102 -0.015394  

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/4839fbbc1cd05e935c419fb2f4d96b2105e7f8e3.png]]
:end:

**** Oferta


#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Oferta + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Oferta.png')

print(df[Oferta + ['PIB']].pct_change().tail(4))
#+END_SRC

#+RESULTS:
:results:
# Out [27]: 
# output
        Agropecuaria  Total Industria  Total Servicos       PIB
2019Q2      0.007891         0.006188        0.002439  0.005406
2019Q3      0.011709         0.007511        0.003180  0.004618
2019Q4     -0.004082         0.000195        0.006761  0.003655
2020Q1      0.005651        -0.013793       -0.016362 -0.015394

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/57372e79c1f7d0213e749718ec1996ac93157539.png]]
:end:


*** Contribuição para variação

**** Demanda

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig = plt.Figure()
ax = plt.gca()
ax2 = fig.add_axes([0.15,0.7,0.2,0.2])

df[Demanda].diff().apply(lambda x: x/(df["PIB"].shift())).tail(8).plot(
    kind = 'bar', 
    stacked = True, 
    ax = ax,
    color = (
        "tomato",
        "darkred",
        "darkslateblue",
        "tan",
        "khaki"
    ),
    width = 0.75,
    edgecolor='black'
)
plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Contribuição para variação do PIB', color='black')

ax.text(0.95, -0.3, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.3, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
#ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Contrib_Demanda.png')

print(df[Demanda].diff().apply(lambda x: x/(df["PIB"].shift())).tail(8))
#+END_SRC

#+RESULTS:
:results:
# Out [28]: 
# output
        Consumo das Familias  Consumo do Governo      FBCF  Exportacao  \
2018Q2              0.000411            0.000829 -0.002023   -0.003944   
2018Q3              0.003452            0.000556  0.007673    0.008579   
2018Q4              0.001663           -0.002415 -0.000270    0.002493   
2019Q1              0.004940            0.001095 -0.002769   -0.005361   
2019Q2              0.002820           -0.000532  0.004298   -0.003278   
2019Q3              0.003134           -0.000706  0.003036   -0.003278   
2019Q4              0.002868            0.000755 -0.004795    0.003009   
2020Q1             -0.013574            0.000433  0.005351   -0.001238   

        Importacao  
2018Q2    0.003814  
2018Q3   -0.012351  
2018Q4    0.006794  
2019Q1    0.000665  
2019Q2   -0.002057  
2019Q3   -0.003507  
2019Q4    0.004788  
2020Q1   -0.003904  

# text/plain
: <Figure size 432x288 with 1 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/b4e59aefc47c0f6b4ca741d61ebe4e966de134e8.png]]
:end:

**** Oferta

#+BEGIN_SRC ipython :session PIB :tangle ./codes/PIB.py
fig, ax = plt.subplots(1,1,figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


#df["PIB"].pct_change().tail(12).plot(ax = ax, kind = 'line', legend = True, color = 'black')
df[Oferta].diff().apply(lambda x: x/(df["VA"].shift())).tail(8).plot(
    kind = 'bar', 
    stacked = True, 
    ax = ax,
    color = (
        "green",
    #    "darkred",
        "darkslateblue",
        "tan",
    #    "khaki"
    ),
    cmap="Set1",
    width = 0.75,
    edgecolor='black'
)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Contribuição para variação do valor adicionado', color='black')

ax.text(0.95, -0.3, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.3, 'Atualizado em {}. Último dado disponível: {}'.format(datetime.datetime.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y))) 
#ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.show()
fig.savefig('./figs/PIB/Contrib_Oferta.png')

print(df[Oferta].diff().apply(lambda x: x/(df["VA"].shift())).tail(8))
#+END_SRC

#+RESULTS:
:results:
# Out [29]: 
# output
/home/gpetrini/.local/lib/python3.8/site-packages/pandas/plotting/_matplotlib/core.py:218: UserWarning: 'color' and 'colormap' cannot be used simultaneously. Using 'color'
  warnings.warn(
/home/gpetrini/.local/lib/python3.8/site-packages/pandas/plotting/_matplotlib/style.py:27: UserWarning: 'color' and 'colormap' cannot be used simultaneously. Using 'color'
  warnings.warn(
        Agropecuaria  Total Industria  Total Servicos
2018Q2      0.000223        -0.001063        0.001793
2018Q3      0.000821         0.000241        0.003313
2018Q4      0.000504        -0.000879        0.000476
2019Q1     -0.000773        -0.000027        0.002749
2019Q2      0.000624         0.001329        0.001736
2019Q3      0.000929         0.001616        0.002259
2019Q4     -0.000326         0.000042        0.004796
2020Q1      0.000447        -0.002961       -0.011628

# text/plain
: <Figure size 648x288 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/006f9c8b5a1420511cea75997fc149369a2d681b.png]]
:end:

*** Carregamento estatístico



* Setor Externo


** Balanço de Pagamentos

#+BEGIN_SRC ipython :session BP :tangle ./codes/BP.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import matplotlib.dates as mdates
import matplotlib.ticker as ticker
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/SetorExterno/'
corona = '2020-03-18' # More than 60 cases in Brazil
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [4]: 
:end:


*** Balança comercial

#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_Total_MDIC'
sheet = "Saldo Semanal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '1999-05-01',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='W', 
    #periods=(1241-12)
    )
df = df[start_year:]
df.index.name = ''
df.drop(['Semana Referência', 'Número dias úteis'], axis='columns', inplace=True)
df.columns = [
    "Exportações",
    "Exportações Média diária",
    "Importações",
    "Importações Média diária",
    "Saldo Comercial",
    "Saldo Comercial Média diária",
]

fig, ax = plt.subplots(figsize=(8,5))
df[['Exportações', 'Importações', 'Saldo Comercial']].plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [5]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/f1c4885a01e6444c6609a1d07aa340fa6875fa4f.png]]
:end:


#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_Total_MDIC'
sheet = "Saldo Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    thousands='.'
)[0:]
df = df.apply(pd.to_numeric)
# df.index = pd.date_range(
#     start = '1999-05-01',
#     periods=df.shape[0],
#     #end='2020-05-31',
#     freq='M', 
#     #periods=(1241-12)
#     )
df.index = pd.to_datetime(df.index, format="%Y-%m")
df = df[start_year:]
df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df.drop(['DU'], axis='columns').plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [7]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/cc881955cf4dd79046a9ddaba863ddd499bf2f9a.png]]
:end:


#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Exportacao_Importacao_FUNCEX'
sheet = "Funcex Dessaz"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df = df[start_year:]
df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [8]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/650e18211ef6f97bf0f8524555fb7cea6542f458.png]]
:end:


*** Conta corrente (%PIB)

#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Conta_Corrente_pct_PIB_Bacen_BPM6'
sheet = "Conta Corrente"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df = df[start_year:]
df.index.name = ''
df.columns = [
    "STC Mensal", "STC últimos 12 meses", "Saldo de Transações Correntes",
    "IED Mensal", "IED últimos 12 meses", "Investimento Externo Direto",
    "NFE Mensal", "NFE últimos 12 meses", "Necessidade Financiamento Externo",
    "PIB últimos 12 meses"
]
fig, ax = plt.subplots(figsize=(8,5))
df[[
    "Saldo de Transações Correntes",
    "Investimento Externo Direto",
    "Necessidade Financiamento Externo"
]].plot(
    title = sheet + "\n(em % PIB)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [10]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/f6c8f5fbe4472c0801241dc39870a218a6e8cb6d.png]]
:end:

*** Balança Comercial por país (mensal)

#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Exportações Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
principais = df.iloc[-1].sort_values(ascending=False).index[:7].to_list()
outros = df.iloc[-1].sort_values(ascending=False).index[7:].to_list()

fig, ax = plt.subplots(figsize=(8,5))
df.iloc[-1].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    color='lightgray',
    edgecolor='black',
    lw=2, 
    zorder=1,
    stacked=False,
    label=f"{df.index[-1]: %b de %Y}",
    alpha=.5
)
df.iloc[-2].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=0,
    color='black',
    stacked=False,
    label=f"{df.index[-2]: %b de %Y}"
)
df.iloc[-3].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=-1,
    color='white',
    stacked=False,
    label=f"{df.index[-3]: %b de %Y}"
)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [11]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/c3ff075133f390045c0fb620ae17d0d8ae93f0b8.png]]
:end:


#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Exportações Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
df["Outros"] = df[outros].sum(axis=1)
df = df[principais + ["Outros"]]

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = file_name.replace("_", " ") + "\n" + sheet + "\n Série histórica",
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    stacked=True,
)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
# Define the date format
ax2 = plt.axes([0.7,0.7,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + "_SerieHistorica" +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [12]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/94e3a318f5fa3b548791774e379fcc93c0ac6151.png]]
:end:

**** Importações

#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Importações Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
principais = df.iloc[-1].sort_values(ascending=False).index[:7].to_list()
outros = df.iloc[-1].sort_values(ascending=False).index[7:].to_list()

fig, ax = plt.subplots(figsize=(8,5))
df.iloc[-1].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    color='gray',
    edgecolor='black',
    lw=2, 
    zorder=1,
    stacked=False,
    label=f"{df.index[-1]: %b de %Y}",
    alpha=.5
)
df.iloc[-2].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=0,
    color='black',
    stacked=False,
    label=f"{df.index[-2]: %b de %Y}"
)
df.iloc[-3].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=-1,
    color='white',
    stacked=False,
    label=f"{df.index[-3]: %b de %Y}"
)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [13]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/418cb4f4d4375891918713f399f1fd90e9c5c223.png]]
:end:


#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Importações Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
df["Outros"] = df[outros].sum(axis=1)
df = df[principais + ["Outros"]]

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = file_name.replace("_", " ") + "\n" + sheet + "\n Série histórica",
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    stacked=True,
)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
# Define the date format
ax2 = plt.axes([0.7,0.7,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + "_SerieHistorica" +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [14]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/5deabc9a2c1ef0035dab475172a88f0cbcbb7efa.png]]
:end:


*** Saldo Comercial

#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Saldo Comercial Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
principais = df.iloc[-1].sort_values(ascending=False).index[:7].to_list()
outros = df.iloc[-1].sort_values(ascending=False).index[7:].to_list()


fig, ax = plt.subplots(figsize=(8,5))
df.iloc[-1].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    color='lightgray',
    edgecolor='black',
    lw=2, 
    zorder=1,
    stacked=False,
    label=f"{df.index[-1]: %b de %Y}",
    alpha=.5
)
df.iloc[-2].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=0,
    color='black',
    stacked=False,
    label=f"{df.index[-2]: %b de %Y}"
)
df.iloc[-3].sort_values(ascending=False).plot(
    title = file_name.replace("_", " ") + "\n" + sheet,
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    zorder=-1,
    color='white',
    stacked=False,
    label=f"{df.index[-3]: %b de %Y}"
)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.7,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [15]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/45699a516d97feebeb7f7e04293a5e946ff61c4c.png]]
:end:


#+BEGIN_SRC ipython  :session BP :tangle ./codes/BP.py
file_name = 'Balanca_Comercial_por_Pais_Funcex'
sheet = "Saldo Comercial Mensal"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True,
    index_col=[0], 
    skiprows=11, 
    na_values='-' 
)[0:]
df = df.apply(pd.to_numeric)
df.index = pd.to_datetime(df.index, format="%Y-%m")
df.index.name = ''
df["Outros"] = df[outros].sum(axis=1)
df = df[principais + ["Outros"]]

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = file_name.replace("_", " ") + "\n" + sheet + "\n Série histórica",
    ax = ax,
    kind='bar', 
    edgecolor='black',
    lw=2, 
    stacked=True,
)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax.axhline(y=0, ls='-', lw=1, color='black')

def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
# Define the date format
ax2 = plt.axes([0.7,0.7,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + "_SerieHistorica" +  '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [16]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/21bc45cb0da9893e5fef8023e5101cfef69cdbcb.png]]
:end:

** China

#+BEGIN_SRC ipython :session China :tangle ./codes/China.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import matplotlib.dates as mdates
import matplotlib.ticker as ticker
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/SetorExterno/'
corona = '2020-03-18' # More than 60 cases in Brazil
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [1]: 
:end:


#+BEGIN_SRC ipython  :session China :tangle ./codes/China.py

file_name = 'China_Banco_dados'
sheet = "Atividade Econômica"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=10,
    na_values='-'
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '1994-01-01',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='M'
    )
df = df['2019-01-01':]
df = df.fillna(method='ffill')
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [4]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/ce747718196bb9c2532973ff223629adeef0ec90.png]]
:end:

#+BEGIN_SRC ipython  :session China :tangle ./codes/China.py

file_name = 'China_Banco_dados'
sheet = "PIB Trimestral Dessaz"
df = pd.read_excel(
    file_path + file_name + '.xlsx', 
    sheet_name=sheet, 
    parse_dates=True, # Check data-parser -> %m/%Y not %m/%d
    index_col=[0], 
    skiprows=11,
    na_values='-'
)[0:]
df.index = pd.date_range( # Check for NaN
    start = '1994-01-01',
    periods=df.shape[0],
    #end='2020-05-31',
    freq='Q'
    )
df = df['2019-01-01':]
df = df.fillna(method='ffill')
df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = file_name.replace('_', ' ')+'\n' + sheet,
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + sheet.replace(' ', '') + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [7]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/b1fdb470863796d1f9a0279fd52036b836972e32.png]]
:end:



* Índices de atividade setoriais

#+BEGIN_SRC ipython :session setoriais :tangle ./codes/setoriais.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/'
image_path = './figs/Setoriais/'
corona = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [5]: 
:end:


** Pesquisa Industrial Mensal (PIM)

#+BEGIN_SRC ipython :session setoriais :tangle ./codes/setoriais.py
file_name = "PIM_IBGE"
df = pd.read_excel(
    file_path + file_name + ".xlsx",
    sheet_name = "Seções Ativi Dessaz",
    skiprows = 11,
    usecols = "A:D",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Pesquisa Industrial Mensal (PIM)\nSeções de atividades desazonalizadas",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [6]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/5034a4e79dd10e24d95e11c9313ca58667edc74f.png]]
:end:


** Pesquisa Mensal do Comércio (PMC)
   
#+BEGIN_SRC ipython :session setoriais :tangle ./codes/setoriais.py
file_name = "PMC_IBGE"
df = pd.read_excel(
    file_path + file_name + ".xlsx",
    sheet_name = "Volume Vendas Dessaz",
    skiprows = 11,
    usecols = "A:D,F,G,J:P",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]
df.columns = [
    "Comércio Varejista Restrito",
    "Combustíveis e Lubiricantes",
    "Hipermercados, Supermercados, Prod. Alimentícios, Bebidas e Fumo",
    "Tecidos, Vestuário e Calçados",
    "Móveis e Eletrodomésticos",
    "Artigos Farmacêuticos, Médicos, Ortopédicos, de Perfumaria e Cosméticos",
    "Livros, Jornais, Revistas e Papelaria",
    "Equipamentos e Materiais para Escritório, Informática e Comunicação",
    "Outros Artigos de Uso Pessoal e Doméstico",
    "Veículos, Motos, Partes e Peças",
    "Material de Construção",
    "Comércio Varejista Ampliado",
]

UsoPessoalDomestico = [
    "Artigos Farmacêuticos, Médicos, Ortopédicos, de Perfumaria e Cosméticos",
    "Livros, Jornais, Revistas e Papelaria",
    "Equipamentos e Materiais para Escritório, Informática e Comunicação",
    "Outros Artigos de Uso Pessoal e Doméstico",
]


fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Pesquisa Mensal do Comércio (PMC)\nVolume de Vendas Dessazonalizado",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [8]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/cde2ae2a2c6518d80eceef680eb0610d47f706c1.png]]
:end:


** Pesquisa Mensal de Serviços (PMS)

#+BEGIN_SRC ipython :session setoriais :tangle ./codes/setoriais.py
file_name = "PMS_IBGE"
df = pd.read_excel(
    file_path + file_name + ".xlsx",
    sheet_name = "Volume dessaz",
    skiprows = 11,
    usecols = "A:C,F,K,N,S",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]
df.columns = [
    "Total Geral",
    "Serviços prestados às Famílias",
    "Serviços de informação e comunicação",
    "Serviços Profissionais, Administrativos e Complementares",
    "Transportes, Serviços auxiliares aos transportes e Correio",
    "Outros serviços"
]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Pesquisa Mensal de Serviços (PMS)\nÍndice de Volume de serviços dessazonalizado",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_name + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [9]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/181f90829a4ff703f104c216bbca7ddef8caedba.png]]
:end:

* Emprego

#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
%config InlineBackend.figure_format = 'retina'

import pandas as pd
import numpy as np

from datetime import datetime as dt
from datetime import timedelta

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.image as image
import seaborn as sns

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)

file_path = './raw/LCA/PNAD_Continua.xlsx'
image_path = './figs/Emprego/'
corona = '2020-04-01' # Começo do isolamento em SP\n(24 de março)
start_year = "2019-01-01"
#+END_SRC

#+RESULTS:
:results:
# Out [1]: 
:end:


** Taxa de desocupação

#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
var = "Taxa de desocupação"
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Dessaz",
    skiprows = 11,
    usecols = "A,F",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]
df.columns = [
    var
]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Taxa de Desocupação\n(% da Força de Trabalho)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + var.replace(" ", "_") + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [3]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/05b5bbdb5ce773aac14916a26efe4f5099ed256d.png]]
:end:


** Massa de renda

#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
var = "Massa de renda real efetiva"
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Dessaz",
    skiprows = 11,
    usecols = "A,R",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''


df = df[start_year:]
df.columns = [
    var
]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Massa de renda real efetiva",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + var.replace(" ", "_") + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [5]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/7b199b092ebb99347bc392053d94a38e134f803e.png]]
:end:


** Desalentados e subocupados

#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
var = "Desalentados_Subocupados"
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Dessaz",
    skiprows = 11,
    usecols = "A,D,S,T",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df.columns = [
    "Força de trabalho",
    "Subocupados",
    "Desalentados"
]
df = df.apply(pd.to_numeric, errors='coerce')
df["Taxa de desalentados"] = df["Desalentados"]/df["Força de trabalho"]
df["Taxa de Subocupados por \ninsuficiência de horas trabalhadas"] = df["Subocupados"]/df["Força de trabalho"]
df = df[start_year:]
df = df[["Taxa de desalentados", "Taxa de Subocupados por \ninsuficiência de horas trabalhadas"]]


fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Taxa de desalentados e subocupatos\n(em % da força de trabalho)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + var.replace(" ", "_") + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [17]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/6de2829bdcf733dd1346f9636df833b29a286378.png]]
:end:

** Rendimento habitual médio por atividade


#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Mensal RHM Setor Real",
    skiprows = 11,
    usecols = "A:K",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df = df[start_year:]


fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Rendimento habitual médio por atividade",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona, color='black', ls='--', lw=1, label='Mais de 60 casos de COVID19')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + "RHM_Setor" + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [21]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/3d8842369ae72eae4769d15d2505555845230e71.png]]
:end:

** População ocupada por atividade

#+BEGIN_SRC ipython  :session pnad :tangle ./codes/pnad.py
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Mensal PO Setor",
    skiprows = 11,
    usecols = "A:K",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df = df[start_year:]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "População ocupada por atividade",
    ax = ax,
    lw = 1.5,
    edgecolor = 'black',
    kind = 'bar', stacked = True
)


def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == 'Jan':
        month += f'\n{label.year}'
    return month
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.show()

fig.savefig(
    image_path + file_path.strip("/")[-1] + "PO_Atividade" + "_" + '.svg',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
# Out [28]: 
# text/plain
: <Figure size 576x360 with 2 Axes>

# image/png
[[file:obipy-resources/62e383af79e91b63c7fc98dd7fb55b3c3ececcb9/18ae86fa0395bd8722bf758ae72aaa47ff7d9d15.png]]
:end:
