#+TITLE: csQCA
#+PROPERTY:header-args R :results output drawer :eval never-export :session QCA :exports both
* HTML headers :noexport:
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>

#+HTML_HEAD: <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
#+HTML_HEAD: <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>


* Loadings packages

#+begin_src R :results none
library(QCA)
library(SetMethods)
library(venn)
library(tidyverse)
library(knitr) # Beatiful tables
library(stargazer)
#+end_src

* Loading uncalibrated dataset

#+begin_src R :results latex table
data(LR)

summary(LR) %>% kable(format='latex')
#+end_src

#+RESULTS:
#+begin_export latex

\begin{tabular}{l|l|l|l|l|l|l}
\hline
  &      DEV &      URB &      LIT &      IND &      STB &      SURV\\
\hline
 & Min.   : 320.0 & Min.   :15.30 & Min.   :38.00 & Min.   :11.20 & Min.   : 2.000 & Min.   :-9.0\\
\hline
 & 1st Qu.: 398.5 & 1st Qu.:25.88 & 1st Qu.:73.30 & 1st Qu.:21.70 & 1st Qu.: 5.250 & 1st Qu.:-8.0\\
\hline
 & Median : 588.0 & Median :33.70 & Median :95.00 & Median :28.85 & Median : 8.000 & Median :-2.5\\
\hline
 & Mean   : 641.3 & Mean   :39.94 & Mean   :84.44 & Mean   :28.79 & Mean   : 8.833 & Mean   : 0.0\\
\hline
 & 3rd Qu.: 871.5 & 3rd Qu.:53.12 & 3rd Qu.:98.00 & 3rd Qu.:36.75 & 3rd Qu.:10.750 & 3rd Qu.: 9.5\\
\hline
 & Max.   :1098.0 & Max.   :78.80 & Max.   :99.90 & Max.   :49.90 & Max.   :21.000 & Max.   :10.0\\
\hline
\end{tabular}
#+end_export

* Calibrating according to textbook

#+begin_src R :results latex table 
LR$DEV <- calibrate(LR$DEV, type = "crisp", thresholds = 550)
LR$URB <- calibrate(LR$URB, type = "crisp", thresholds = 50)
LR$LIT  <- calibrate(LR$LIT, type = "crisp", thresholds = 70)
LR$IND  <- calibrate(LR$IND, type = "crisp", thresholds = 30)
LR$STB  <- 1 - calibrate(LR$STB, type = "crisp", thresholds = 10)
LR$SURV  <- calibrate(LR$SURV, type = "crisp", thresholds = 0)

LR %>% kable(format = "latex") %>% print()
#+end_src

#+RESULTS:
#+begin_export latex

\begin{tabular}{l|r|r|r|r|r|r}
\hline
  & DEV & URB & LIT & IND & STB & SURV\\
\hline
AU & 1 & 0 & 1 & 1 & 0 & 0\\
\hline
BE & 1 & 1 & 1 & 1 & 1 & 1\\
\hline
CZ & 1 & 1 & 1 & 1 & 1 & 1\\
\hline
EE & 0 & 0 & 1 & 0 & 1 & 0\\
\hline
FI & 1 & 0 & 1 & 0 & 1 & 1\\
\hline
FR & 1 & 0 & 1 & 1 & 1 & 1\\
\hline
DE & 1 & 1 & 1 & 1 & 0 & 0\\
\hline
GR & 0 & 0 & 0 & 0 & 0 & 0\\
\hline
HU & 0 & 0 & 1 & 0 & 0 & 0\\
\hline
IE & 1 & 0 & 1 & 0 & 1 & 1\\
\hline
IT & 0 & 0 & 1 & 0 & 1 & 0\\
\hline
NL & 1 & 1 & 1 & 1 & 1 & 1\\
\hline
PL & 0 & 0 & 1 & 0 & 0 & 0\\
\hline
PT & 0 & 0 & 0 & 0 & 0 & 0\\
\hline
RO & 0 & 0 & 0 & 0 & 1 & 0\\
\hline
ES & 0 & 0 & 0 & 0 & 0 & 0\\
\hline
SE & 1 & 0 & 1 & 1 & 1 & 1\\
\hline
UK & 1 & 1 & 1 & 1 & 1 & 1\\
\hline
\end{tabular}
#+end_export

* Truth Table

#+begin_src R :results latex table
TT <- truthTable(
  LR,
  outcome = "SURV",
  conditions = c("DEV", "URB", "LIT", "IND", "STB"),
  complete = TRUE,
  use.letters = FALSE,
  show.cases = TRUE,
  ## sort.by = c("out", "incl", "n"),
  dcc = TRUE # Deviant cases
)
TT %>% stargazerTT(type="latex")
#+end_src

#+RESULTS:
#+begin_export latex

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:54
\begin{table}[!htbp] \centering
  \caption{}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & DEV & URB & LIT & IND & STB & OUT & n & incl & PRI \\
\hline \\[-1.8ex]
32 & $1$ & $1$ & $1$ & $1$ & $1$ & 1 & $4$ & $1$ & $1$ \\
22 & $1$ & $0$ & $1$ & $0$ & $1$ & 1 & $2$ & $1$ & $1$ \\
24 & $1$ & $0$ & $1$ & $1$ & $1$ & 1 & $2$ & $1$ & $1$ \\
1 & $0$ & $0$ & $0$ & $0$ & $0$ & 0 & $3$ & $0$ & $0$ \\
5 & $0$ & $0$ & $1$ & $0$ & $0$ & 0 & $2$ & $0$ & $0$ \\
6 & $0$ & $0$ & $1$ & $0$ & $1$ & 0 & $2$ & $0$ & $0$ \\
2 & $0$ & $0$ & $0$ & $0$ & $1$ & 0 & $1$ & $0$ & $0$ \\
23 & $1$ & $0$ & $1$ & $1$ & $0$ & 0 & $1$ & $0$ & $0$ \\
31 & $1$ & $1$ & $1$ & $1$ & $0$ & 0 & $1$ & $0$ & $0$ \\
3 & $0$ & $0$ & $0$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
4 & $0$ & $0$ & $0$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
7 & $0$ & $0$ & $1$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
8 & $0$ & $0$ & $1$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
9 & $0$ & $1$ & $0$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
10 & $0$ & $1$ & $0$ & $0$ & $1$ & ? & $0$ & $$ & $$ \\
11 & $0$ & $1$ & $0$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
12 & $0$ & $1$ & $0$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
13 & $0$ & $1$ & $1$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
14 & $0$ & $1$ & $1$ & $0$ & $1$ & ? & $0$ & $$ & $$ \\
15 & $0$ & $1$ & $1$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
16 & $0$ & $1$ & $1$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
17 & $1$ & $0$ & $0$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
18 & $1$ & $0$ & $0$ & $0$ & $1$ & ? & $0$ & $$ & $$ \\
19 & $1$ & $0$ & $0$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
20 & $1$ & $0$ & $0$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
21 & $1$ & $0$ & $1$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
25 & $1$ & $1$ & $0$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
26 & $1$ & $1$ & $0$ & $0$ & $1$ & ? & $0$ & $$ & $$ \\
27 & $1$ & $1$ & $0$ & $1$ & $0$ & ? & $0$ & $$ & $$ \\
28 & $1$ & $1$ & $0$ & $1$ & $1$ & ? & $0$ & $$ & $$ \\
29 & $1$ & $1$ & $1$ & $0$ & $0$ & ? & $0$ & $$ & $$ \\
30 & $1$ & $1$ & $1$ & $0$ & $1$ & ? & $0$ & $$ & $$ \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export





* Minimization

** Outcome [1]
*** Parsimonious solution
#+begin_src R :results latex
MIN <- minimize(
  TT,
  outcome="SURV",
  incl.cut = .9,
  include = "?",
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE
)
MIN %>% stargazerSol(
          outcome="SURV",
          show.cases = TRUE,
          sol = 2
        )
#+end_src

#+RESULTS:
#+begin_export latex

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:54
\begin{table}[!htbp] \centering
  \caption{}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
DEV\textasteriskcentered \textasciitilde IND & $1$ & $1$ & $0.250$ & $0$ & FI,IE \\
IND\textasteriskcentered STB & $1$ & $1$ & $0.750$ & $0$ & FR,SE; BE,CZ,NL,UK \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export


*** Intermediary solution

#+begin_src R :results latex
MIN <- minimize(
  TT,
  outcome = "SURV",
  incl.cut = .9,
  include = "?",
  details = TRUE,
  show.cases = TRUE,
  complete = TRUE,
  all.sol = TRUE,
  dir.exp = c(
    1, # DEV
    1, # URB
    1, # LIT
    1, # IND
    1 # STB
  )
)
MIN %>% stargazerSol(
  outcome = "SURV",
  show.cases = TRUE,
)
sol_1 <- MIN
#+end_src

#+RESULTS:
#+begin_export latex
Warning: stack imbalance in '<-', 2 then 5

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:55
\begin{table}[!htbp] \centering
  \caption{}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
DEV\textasteriskcentered LIT\textasteriskcentered STB & $1$ & $1$ & $1$ & $$ & FI,IE; FR,SE; BE,CZ,NL,UK \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export

*** Conservative solution
#+begin_src R :results latex
MIN <- minimize(
  TT,
  outcome="SURV",
  incl.cut = .9,
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE
)
MIN %>% stargazerSol(
          outcome="SURV",
          show.cases = TRUE,
        )
sol_1 <- MIN
#+end_src

#+RESULTS:
#+begin_export latex
Warning: stack imbalance in '<-', 2 then 3

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:40:05
\begin{table}[!htbp] \centering
  \caption{}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
DEV\textasteriskcentered \textasciitilde URB\textasteriskcentered LIT\textasteriskcentered STB & $1$ & $1$ & $0.500$ & $0.250$ & FI,IE; FR,SE \\
DEV\textasteriskcentered LIT\textasteriskcentered IND\textasteriskcentered STB & $1$ & $1$ & $0.750$ & $0.500$ & FR,SE; BE,CZ,NL,UK \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export

** Outcome [0]
*** Conservative soltuion
#+begin_src R :results drawer latex table :var title="Conservative solution"
TT <- truthTable(
  LR,
  outcome = "~SURV",
  conditions = c("DEV", "URB", "LIT", "IND", "STB"),
  complete = TRUE,
  use.letters = FALSE,
  show.cases = TRUE,
  sort.by = c("out", "incl", "n"),
  dcc = TRUE # Deviant cases
)
MIN <- minimize(
  TT,
  outcome="SURV",
  incl.cut = .9,
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE
)
MIN %>% stargazerSol(
          outcome="~SURV",
          show.cases = TRUE,
          sol = 1,
          title = title
        )
sol_0 <- MIN
#+end_src

#+RESULTS:
#+begin_export latex
Warning: stack imbalance in '<-', 2 then 3

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:55
\begin{table}[!htbp] \centering
  \caption{Conservative solution}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
\textasciitilde DEV\textasteriskcentered \textasciitilde URB\textasteriskcentered \textasciitilde IND & $1$ & $1$ & $0.800$ & $0.800$ & GR,PT,ES; RO; HU,PL; EE,IT \\
DEV\textasteriskcentered LIT\textasteriskcentered IND\textasteriskcentered \textasciitilde STB & $1$ & $1$ & $0.200$ & $0.200$ & AU; DE \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export



*** Parsimonious solution
#+begin_src R :results drawer latex table :var title="Parsimonious solution"
TT <- truthTable(
  LR,
  outcome = "~SURV",
  conditions = c("DEV", "URB", "LIT", "IND", "STB"),
  complete = TRUE,
  use.letters = FALSE,
  show.cases = TRUE,
  sort.by = c("out", "incl", "n"),
  dcc = TRUE # Deviant cases
)
MIN <- minimize(
  TT,
  outcome="SURV",
  incl.cut = .9,
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE
)
MIN %>% stargazerSol(
          outcome="~SURV",
          show.cases = TRUE,
          sol = 1,
          title = title
        )
sol_0 <- MIN
#+end_src

#+RESULTS:
#+begin_export latex
Warning: stack imbalance in '<-', 2 then 3

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:55
\begin{table}[!htbp] \centering
  \caption{Parsimonious solution}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
\textasciitilde DEV\textasteriskcentered \textasciitilde URB\textasteriskcentered \textasciitilde IND & $1$ & $1$ & $0.800$ & $0.800$ & GR,PT,ES; RO; HU,PL; EE,IT \\
DEV\textasteriskcentered LIT\textasteriskcentered IND\textasteriskcentered \textasciitilde STB & $1$ & $1$ & $0.200$ & $0.200$ & AU; DE \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export





*** Intermediary solution
#+begin_src R :results drawer latex table :var title="Intermediary solution"
TT <- truthTable(
  LR,
  outcome = "~SURV",
  conditions = c("DEV", "URB", "LIT", "IND", "STB"),
  include = "?",
  complete = TRUE,
  use.letters = FALSE,
  show.cases = TRUE,
  sort.by = c("out", "incl", "n"),
  dir.exp = c(
    0, # DEV
    0, # URB
    0, # LIT
    0, # IND
    0 # STB
  ),
  dcc = TRUE # Deviant cases
)
MIN <- minimize(
  TT,
  outcome="SURV",
  incl.cut = .9,
  include = "?",
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE
)
MIN %>% stargazerSol(
          outcome="~SURV",
          show.cases = TRUE,
          title = title
        )
sol_0 <- MIN
#+end_src

#+RESULTS:
#+begin_export latex

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:55
\begin{table}[!htbp] \centering
  \caption{Intermediary solution}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & inclS & PRI & covS & covU & cases \\
\hline \\[-1.8ex]
\textasciitilde DEV & $1$ & $1$ & $0.800$ & $0.300$ & GR,PT,ES; RO; HU,PL; EE,IT \\
\textasciitilde STB & $1$ & $1$ & $0.700$ & $0.200$ & GR,PT,ES; HU,PL; AU; DE \\
Solution & $1$ & $1$ & $1$ & $$ &  \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export



* Visualizing intermediaries solutions

** Outcome [1]
*** Radar plot
#+begin_src R :results graphics file :file ../figs/csQCA_LR_1.png
png('../figs/csQCA_LR_1.png')
QCAradar(
  results = sol_1,
  outcome = "SURV",
  fit = TRUE,
)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/csQCA_LR_1.png]]
*** Pimplot
#+begin_src R :results graphics file :file ../figs/csQCA_LR_pim1.png
png('../figs/csQCA_LR_pim1.png')
pimplot(
  data = LR,
  results = sol_1,
  outcome = "SURV",
  fit = TRUE,
  crisp = TRUE,
  consH = TRUE,
  all_labels = TRUE,
  markers = TRUE,
  jitter = TRUE
)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/csQCA_LR_pim1.png]]
*** Venn Diagram
#+begin_src R :results file graphics :file ../figs/venn_1.png
png('../figs/venn_1.png')
venn(sol_1)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/venn_1.png]]

** Outcome [0]
*** Radar plot
#+begin_src R :results graphics file :file ../figs/csQCA_LR_0.png
png('../figs/csQCA_LR_0.png')
QCAradar(
  results = sol_0,
  outcome = "SURV",
  fit = TRUE,
  sol = 1
)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/csQCA_LR_0.png]]

*** Pimplot
#+begin_src R :results graphics file :file ../figs/csQCA_LR_pim0.png
png('../figs/csQCA_LR_pim0.png')
pimplot(
  data = LR,
  results = sol_0,
  outcome = "~SURV",
  fit = TRUE,
  crisp = TRUE,
  consH = TRUE,
  all_labels = TRUE,
  markers = TRUE,
  jitter = TRUE
)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/csQCA_LR_pim0.png]]

*** Venn Diagram
#+begin_src R :results file graphics :file ../figs/venn_0.png
png('../figs/venn_0.png')
venn(sol_0)
dev.off()
#+end_src

#+RESULTS:
[[file:../figs/venn_0.png]]


* Robustness check
** Robustness parameters of fit

#+begin_src R :results latex table
IS = sol_1
TT <- truthTable(
  LR,
  outcome = "SURV",
  conditions = c("DEV", "URB", "LIT", "IND", "STB"),
  complete = TRUE,
  use.letters = FALSE,
  show.cases = TRUE,
  sort.by = c("out", "incl", "n"),
  ## dcc = TRUE # Deviant cases
)

MIN <- minimize( ## Changing incl.cut (altering consistency)
  TT,
  outcome="SURV",
  incl.cut = .7,
  include = "? C",
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE,
  n.cuts = 2
) -> TS_1
MIN <- minimize( ## Changing n.cuts
  TT,
  outcome="SURV",
  incl.cut = .9,
  include = "? C",
  details = TRUE,
  show.cases=TRUE,
  complete=TRUE,
  all.sol = TRUE,
  n.cuts = 1
) -> TS_2

TS <- list(TS_1, TS_2)
rob.fit(
  test_sol = TS,
  initial_sol = IS,
  outcome = "SURV"
) %>% stargazer()
#+end_src

#+RESULTS:
#+begin_export latex
Warning: stack imbalance in '<-', 4 then 5
Warning: stack imbalance in '<-', 2 then 3
Warning: stack imbalance in '<-', 4 then 5
Warning: stack imbalance in '<-', 2 then 3

% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: qua, jan 27, 2021 - 16:37:56
\begin{table}[!htbp] \centering
  \caption{}
  \label{}
\begin{tabular}{@{\extracolsep{5pt}} cccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & RF\_cov & RF\_cons & RF\_SC \\
\hline \\[-1.8ex]
Robustness\_Fit & $1$ & $1$ & $1$ \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}
#+end_export
** Raw consistency threshold range
#+begin_src R :eval no
rob.inclrange(
  data = LR,
  step = 0.01,
  max.runs = 10,
  outcome = "SURV",
  conditions = c("DEV","URB","STB","IND","LIT"),
  incl.cut = 0.87,
  n.cut = 2,
  include = "?"
)
#+end_src

